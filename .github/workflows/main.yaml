name: "Terraform action"
on:
    workflow_call:
        inputs:
            environment:
                required: true
                type: string
permissions:
    id-token: write # This is required for aws oidc connection
    contents: read # This is required for actions/checkout
    pull-requests: write # This is required for gh bot to comment PR
env:
    TF_LOG: INFO
    ENVIRONMENT: ${{ inputs.environment }}
    AWS_REGION: ${{ secrets.AWS_REGION }}
jobs:
    deploy:
        environment: ${{ inputs.environment }}
        runs-on: ubuntu-latest
        defaults:
            run:
                shell: bash
                working-directory: terraform
        steps:
            - name: Git checkout
              uses: actions/checkout@v3

            - name: Setup Node
              uses: actions/setup-node@v6
              with:
                node-version: 25
            
            - name: Install App Dependencies
              run: npm ci
            
            - name: Build Application
              run: npm run build

            - name: Configure AWS credentials from AWS account
              uses: aws-actions/configure-aws-credentials@v1
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE }}
                  aws-region: ${{ secrets.AWS_REGION }}
                  role-session-name: GitHub-OIDC-TERRAFORM

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v2
              with:
                  terraform_version: 1.6.5

            - name: Terraform fmt
              id: fmt
              run: terraform fmt -check
              continue-on-error: true

            - name: Terraform Init
              id: init
              env:
                  AWS_BUCKET_NAME: ${{ secrets.AWS_BUCKET_NAME }}
                  AWS_BUCKET_KEY_NAME: "${{github.event.repository.name}}/${{secrets.AWS_REGION}}"
              run: |
                  terraform init \
                      -backend-config="bucket=${AWS_BUCKET_NAME}" \
                      -backend-config="key=${AWS_BUCKET_KEY_NAME}" \
                      -backend-config="region=${AWS_REGION}"

            - name: Setup Terraform Environment
              id: terraform-env
              run: |
                  APP_NAME="${{ secrets.APP_NAME }}"

                  echo "APP_NAME=$APP_NAME"

                  WORKSPACE="${{inputs.environment}}"

                  # Add variables to step output context
                  echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
                  echo "WORKSPACE=$WORKSPACE" >> $GITHUB_OUTPUT

                  # Select terraform workspace
                  terraform workspace select -or-create=true $WORKSPACE
            - name: Terraform Validate
              id: validate
              run: terraform validate -no-color

            - name: Debug Directories
              run: |
                  ls -l ..
                  ls -l ../src

            - name: Terraform Plan
              id: plan
              if: github.event_name == 'pull_request'
              continue-on-error: true
              run: |
                  terraform plan \
                      -no-color \
                      -var="domain=${{ secrets.DOMAIN }}" \
                      -var="app_name=${{ steps.terraform-env.outputs.APP_NAME }}"

            - uses: actions/github-script@v6
              if: github.event_name == 'pull_request'
              env:
                  PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
                      #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
                      #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`
                      <details><summary>Validation Output</summary>

                      \`\`\`\n
                      ${{ steps.validate.outputs.stdout }}
                      \`\`\`

                      </details>

                      #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`

                      <details><summary>Show Plan</summary>

                      \`\`\`\n
                      ${process.env.PLAN}
                      \`\`\`

                      </details>

                      *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: output
                      })

            - name: Terraform Plan Status
              if: steps.plan.outcome == 'failure'
              run: exit 1

            - name: Terraform Apply
              if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') && github.event_name == 'push'
              run: |
                  terraform apply \
                      -auto-approve \
                      -input=false \
                      -var="domain=${{ secrets.DOMAIN }}" \
                      -var="app_name=${{ steps.terraform-env.outputs.APP_NAME }}"
